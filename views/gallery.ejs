<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Edit Achievement</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
<nav class="navbar navbar-expand-sm bg-dark navbar-dark">
<div class="container-fluid">
<a class="navbar-brand" href="/">Interest Group</a>
</div>
</nav>
<div class="container mt-4">
<h1 class="mb-4">Gallery</h1>

<!-- Filter -->
<form method="GET" action="/gallery" class="form-inline mb-3">
<label for="ig-filter" class="mr-2">Filter by IG:</label>
<select id="ig-filter" name="ig_id" class="form-control" onchange="this.form.submit()">
    <option value="">All IGs</option>
    <% igs.forEach(ig => { 
    let isSelected = ig.id == selectedIg ? 'selected' : '';
%>
    <option value="<%= ig.id %>" <%= isSelected %>><%= ig.name %></option>
<% }); %>

</select>
</form>
<form method="GET" action="/gallery/search" class="form-inline d-flex mb-3">
    <input 
        class="form-control me-2" 
        type="search" 
        name="q" 
        placeholder="Search gallery by IG or caption" 
        aria-label="Search" 
        required>
    <button class="btn btn-outline-secondary" type="submit">Search</button>
</form>

<!-- Upload / Manage Buttons -->
<div class="mb-3 text-right">
<% if (isAdmin) { %>
    <a href="/gallery/upload" class="btn btn-primary">Upload</a>
    <a href="/gallery/manage" class="btn btn-secondary">Manage</a>
<% } else { %>
    <a href="/gallery/request" class="btn btn-primary">Request Upload</a>
<% } %>
</div>

<!-- Flash Messages -->
<% if (messages.success) { %>
<div class="alert alert-success"><%= messages.success %></div>
<% } %>
<% if (messages.error) { %>
<div class="alert alert-danger"><%= messages.error %></div>
<% } %>

<!-- Gallery Items -->
<% if (!galleries.length) { %>
<div class="alert alert-info">No media found.</div>
<% } else { %>
<div class="row">
    <% galleries.forEach(item => { %>
    <div class="col-md-4 mb-4">
        <div class="card">
        <% if (item.media_url.endsWith('.mp4') || item.media_url.endsWith('.mov')) { %>
            <video controls class="card-img-top">
            <source src="<%= item.media_url %>">
            </video>
        <% } else { %>
            <img src="<%= item.media_url %>" class="card-img-top" alt="Gallery media">
        <% } %>

        <div class="card-body">
            <h5><%= item.caption %></h5>
            <small class="text-muted"><%= item.ig_name %> â€¢ <%= new Date(item.upload_date).toLocaleDateString() %></small>

            <% if (isAdmin) { %>
            <div class="mt-2">
                <a href="/gallery/delete/<%= item.id %>" class="btn btn-sm btn-danger" onclick="return confirm('Delete this item?')">Delete</a>
            </div>
            <% } %>

            <hr>

            <!-- Comments -->
            <div id="comments-<%= item.id %>">
            <button class="btn btn-sm btn-outline-secondary" onclick="loadComments('<%= item.id %>')">Load Comments</button>
            <div class="comments-container mt-2"></div>
            </div>

            <!-- Add Comment -->
            <form onsubmit="postComment(event, '<%= item.id %>')" class="mt-2">
            <textarea class="form-control mb-2" name="comment" placeholder="Add a comment..." required></textarea>
            <button class="btn btn-sm btn-primary">Post</button>
            </form>
        </div>
        </div>
    </div>
    <% }); %>
</div>
<% } %>
</div>

<script>
function loadComments(id) {
fetch(`/gallery/${id}/comments`)
.then(res => res.json())
.then(data => {
    const box = document.querySelector(`#comments-${id} .comments-container`);
    box.innerHTML = data.length ? data.map(c => `
    <div><strong>${c.student_name}</strong><br>${c.comment}<br><small>${new Date(c.created_at).toLocaleString()}</small><hr></div>
    `).join('') : '<p class="text-muted">No comments yet.</p>';
});
}

function postComment(event, id) {
event.preventDefault();
const form = event.target;
const data = new URLSearchParams(new FormData(form));

fetch(`/gallery/${id}/comment`, {
method: 'POST',
headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
body: data
}).then(res => {
if (res.ok) {
    form.reset();
    loadComments(id);
} else {
    alert('Failed to post comment');
}
});
}
</script>
